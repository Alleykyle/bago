{% load static %}
{% load dict_filters %}  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Requirements Monitoring System</title>
  <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'CSS/requirements_monitoring.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ========== WELCOME PAGE ========== */
    .welcome-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .welcome-card {
      background: white;
      border-radius: 20px;
      padding: 60px 50px;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .welcome-logo {
      width: 100px;
      height: 100px;
      background: #0b1a50;
      border-radius: 50%;
      margin: 0 auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
    }

    .welcome-card h1 {
      font-size: 32px;
      color: #1a202c;
      margin-bottom: 20px;
    }

    .welcome-card p {
      font-size: 16px;
      color: #4a5568;
      line-height: 1.6;
      margin-bottom: 40px;
    }

    .get-started-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 15px 50px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .get-started-btn:hover {
      background: #4338CA;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }

    /* ========== MAIN MONITORING CONTAINER ========== */
    .monitoring-container {
      display: none;
      min-height: 100vh;
      background: linear-gradient(to bottom, #e5e7eb 0%, #93a5cf 100%);
    }

    .monitoring-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 200px;
      background: white;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto; /* Add this */
      max-height: 100vh; /* Add this */
    }

    .sidebar h3 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
    }

    .barangay-list {
      list-style: none;
      max-height: calc(100vh - 200px); /* Add this */
      overflow-y: auto; /* Add this */
    }

    .barangay-list li {
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        position: relative;
        border-left: 4px solid transparent;

    }

    
/* Status Colors */
.barangay-list li.status-red {
  background: #fee2e2;
  border-left-color: #dc2626;
  color: #991b1b;
}

.barangay-list li.status-red:hover {
  background: #fecaca;
}

.barangay-list li.status-yellow {
  background: #fef3c7;
  border-left-color: #f59e0b;
  color: #92400e;
}

.barangay-list li.status-yellow:hover {
  background: #fde68a;
}

.barangay-list li.status-green {
  background: #d1fae5;
  border-left-color: #10b981;
  color: #065f46;
}

.barangay-list li.status-green:hover {
  background: #a7f3d0;
}

.barangay-list li.status-blue {
  background: #dbeafe;
  border-left-color: #3b82f6;
  color: #1e40af;
}

.barangay-list li.status-blue:hover {
  background: #bfdbfe;
}

.barangay-list li.status-gray {
  background: #f3f4f6;
  border-left-color: #9ca3af;
  color: #4b5563;
}

.barangay-list li.status-gray:hover {
  background: #e5e7eb;
}

/* Active state (selected) */
.barangay-list li.active.status-red {
  background: #dc2626;
  color: white;
  border-left-color: #991b1b;
}

.barangay-list li.active.status-yellow {
  background: #f59e0b;
  color: white;
  border-left-color: #d97706;
}

.barangay-list li.active.status-green {
  background: #10b981;
  color: white;
  border-left-color: #059669;
}

.barangay-list li.active.status-blue {
  background: #3b82f6;
  color: white;
  border-left-color: #2563eb;
}

.barangay-list li.active.status-gray {
  background: #6b7280;
  color: white;
  border-left-color: #4b5563;
}

/* Status indicator dot */
.barangay-list li::before {
  content: '';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  opacity: 0.5;
}

.barangay-list li.active::before {
  opacity: 1;
  background: white;
}

/* Tooltip on hover */
.barangay-list li[title]:hover::after {
  content: attr(title);
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  margin-left: 10px;
  padding: 8px 12px;
  background: #1f2937;
  color: white;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

    .content {
  flex: 1;
  padding: 30px;
  overflow-y: auto; /* Enable vertical scrolling */
  height: 100vh; /* Full viewport height */
}

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .top-bar h1 {
      font-size: 28px;
      color: #1a202c;
    }

    .top-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .back-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .back-button:hover {
      background: #4338CA;
    }

    .user-icon {
      width: 40px;
      height: 40px;
      background: #1a202c;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }

    /* User Dropdown Menu */
    .user-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 10px 0;
      min-width: 150px;
      display: none;
      z-index: 1000;
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #1a202c;
    }

    .user-dropdown-item:hover {
      background: #f3f4f6;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      border: none;
      background: white;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .tab:hover {
      background: #e5e7eb;
    }

    .tab.active {
      background: #007bff;
      color: white;
    }

    .search-box {
      padding: 10px 20px;
      border: 1px solid #d1d5db;
      border-radius: 25px;
      margin-left: auto;
      width: 250px;
    }

    /* Barangay Header */
    .barangay-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .barangay-header h2 {
      font-size: 24px;
      color: #1a202c;
    }

    .date {
      color: #6b7280;
      font-size: 14px;
    }

    .week-btn {
      margin-left: auto;
      padding: 8px 15px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      position: relative;
    }

    /* Week Dropdown */
    .week-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 10px 0;
      min-width: 150px;
      display: none;
      z-index: 100;
    }

    .week-dropdown.show {
      display: block;
    }

    .week-dropdown-item {
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #1a202c;
    }

    .week-dropdown-item:hover {
      background: #f3f4f6;
    }

    /* Task Card */
    .task-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .task-card:hover {
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }

    .task-card h3 {
      font-size: 18px;
      color: #1a202c;
      margin-bottom: 15px;
    }

    .status {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .status.accomplished {
      color: #10b981;
    }

    .status.in-progress, .status.in_progress {
      color: #f59e0b;
    }

    .status.pending {
      color: #ef4444;
    }

    .task-card p {
      color: #4a5568;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .last-update {
      color: #9ca3af;
      font-size: 13px;
    }

    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .view-btn, .delete-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .view-btn {
      background: #007bff;
      color: white;
    }

    .view-btn:hover {
      background: #4338CA;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 16px;
      color: #6b7280;
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ========== DETAIL/INPUT PAGE ========== */
    .detail-container {
      display: none;
      min-height: 100vh;
      background: linear-gradient(to bottom, #e5e7eb 0%, #93a5cf 100%);
    }

    .detail-layout {
      display: flex;
      min-height: 100vh;
    }

    .detail-content {
      flex: 1;
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .detail-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .detail-header h2 {
      font-size: 24px;
      color: #1a202c;
    }

    .update-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .update-btn:hover {
      background: #4338CA;
    }

    .detail-description {
      margin-bottom: 30px;
      color: #4a5568;
      line-height: 1.6;
    }

    .input-section {
      margin-bottom: 30px;
    }

    .input-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1a202c;
    }

    .input-section textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }

    .upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .upload-area:hover {
      border-color: #007bff;
      background: #f3f4f6;
    }

    .upload-icon {
      font-size: 48px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .upload-area p {
      color: #6b7280;
      font-size: 14px;
    }

    .uploaded-files {
      margin-top: 15px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background: #f3f4f6;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-item span {
      font-size: 14px;
      color: #1a202c;
    }

    .remove-file {
      background: #ef4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .remove-file:hover {
      background: #dc2626;
    }

    .detail-footer {
      display: flex;
      justify-content: space-between;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      margin-top: 30px;
    }

    .detail-footer .info {
      color: #6b7280;
      font-size: 14px;
    }

    .submit-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 40px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .submit-btn:hover {
      background: #059669;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1a202c;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      background: #10b981;
    }

    .toast.error {
      background: #ef4444;
    }
    /* ========== NOTIFICATION SYSTEM ========== */
.notification-container {
  position: relative;
}

.notification-bell {
  position: relative;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  transition: all 0.3s;
}

.notification-bell:hover {
  transform: scale(1.1);
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 11px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

.notification-dropdown {
  position: absolute;
  top: 50px;
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  width: 380px;
  max-height: 500px;
  display: none;
  z-index: 1000;
  overflow: hidden;
}

.notification-dropdown.show {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

    /* ========== NOTIFICATION SYSTEM ========== */
.notification-container {
  position: relative;
  display: inline-block;
}

.notification-bell {
  position: relative;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notification-bell:hover {
  transform: scale(1.05);
  border-color: #007bff;
  box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 11px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

.notification-dropdown {
  position: absolute;
  top: 60px;
  right: -50px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  border: 1px solid #e5e7eb;
  width: 420px;
  max-height: 550px;
  display: none;
  z-index: 9999;
  overflow: hidden;
}

.notification-dropdown.show {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.notification-header {
  padding: 18px 20px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9fafb;
}

.notification-header h3 {
  font-size: 18px;
  color: #1a202c;
  margin: 0;
  font-weight: 700;
}

.mark-all-read {
  background: none;
  border: none;
  color: #007bff;
  font-size: 13px;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.2s;
}

.mark-all-read:hover {
  background: #e5e7eb;
}

.notification-list {
  max-height: 400px;
  overflow-y: auto;
}

.notification-item {
  padding: 15px 20px;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.notification-item:hover {
  background: #f9fafb;
}

.notification-item.unread {
  background: #eff6ff;
}

.notification-item.unread::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  background: #3b82f6;
  border-radius: 50%;
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-bottom: 8px;
  
}

.notification-icon.overdue {
  background: #fee2e2;
  color: #dc2626;
}

.notification-icon.upcoming {
  background: #fef3c7;
  color: #f59e0b;
}

.notification-icon.completed {
  background: #d1fae5;
  color: #10b981;
}

.notification-icon.info {
  background: #dbeafe;
  color: #3b82f6;
}

.notification-content {
  margin-left: 15px;
}

.notification-title {
  font-weight: 600;
  color: #1a202c;
  font-size: 14px;
  margin-bottom: 4px;
}

.notification-message {
  color: #6b7280;
  font-size: 13px;
  line-height: 1.4;
  margin-bottom: 4px;
}

.notification-time {
  color: #9ca3af;
  font-size: 12px;
}

.notification-empty {
  padding: 60px 20px;
  text-align: center;
  color: #9ca3af;
  background: white;
}

.notification-empty-icon {
  font-size: 64px;
  margin-bottom: 15px;
  opacity: 0.6;
  filter: grayscale(50%);
}

.notification-empty p {
  font-size: 16px;
  color: #6b7280;
  font-weight: 500;
}

.notification-footer {
  padding: 12px 20px;
  border-top: 1px solid #e5e7eb;
  text-align: center;
  background: #f9fafb;
}

.view-all-btn {
  background: none;
  border: none;
  color: #007bff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.2s;
}

.view-all-btn:hover {
  background: #e5e7eb;
}/* ========== MODAL STYLES ========== */
.modal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.modal-content {
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  font-weight: bold;
  color: #9ca3af;
  cursor: pointer;
  transition: color 0.3s;
}

.close-modal:hover {
  color: #1a202c;
}

.modal-content h2 {
  font-size: 24px;
  color: #1a202c;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e5e7eb;
}

/* Profile Modal */
.profile-modal {
  max-width: 700px;
}

.profile-content {
  display: grid;
  gap: 30px;
  margin-bottom: 30px;
}

.profile-avatar {
  text-align: center;
}

.avatar-circle {
  width: 120px;
  height: 120px;
  background: #0b1a50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  margin: 0 auto 15px;
}

.change-avatar-btn {
  background: #e5e7eb;
  border: none;
  padding: 8px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.change-avatar-btn:hover {
  background: #d1d5db;
}

.profile-info {
  display: grid;
  gap: 15px;
}

.info-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.info-group label {
  font-weight: 600;
  color: #1a202c;
  font-size: 14px;
}

.info-group input {
  padding: 12px 15px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  background: #f9fafb;
  transition: all 0.3s;
}

.info-group input:not([readonly]):focus {
  outline: none;
  border-color: #007bff;
  background: white;
}

.profile-actions,
.modal-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  padding-top: 20px;
  border-top: 2px solid #e5e7eb;
}

.btn-primary {
  background: #007bff;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-primary:hover {
  background: #4338CA;
}

.btn-secondary {
  background: #e5e7eb;
  color: #1a202c;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-secondary:hover {
  background: #d1d5db;
}

/* Password Modal */
.password-modal {
  max-width: 500px;
}

.password-form {
  display: grid;
  gap: 20px;
  margin-bottom: 20px;
}

/* Settings Modal */
.settings-modal {
  max-width: 600px;
}

.settings-content {
  display: grid;
  gap: 30px;
  margin-bottom: 20px;
}

.setting-group {
  padding: 20px;
  background: #f9fafb;
  border-radius: 10px;
}

.setting-group h3 {
  font-size: 18px;
  color: #1a202c;
  margin-bottom: 15px;
}

.toggle-switch {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px 0;
  cursor: pointer;
  position: relative;
}

.toggle-switch input[type="checkbox"] {
  display: none;
}

.slider {
  width: 50px;
  height: 26px;
  background: #d1d5db;
  border-radius: 13px;
  position: relative;
  transition: background 0.3s;
}

.slider::before {
  content: '';
  position: absolute;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: white;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}

.toggle-switch input[type="checkbox"]:checked + .slider {
  background: #007bff;
}

.toggle-switch input[type="checkbox"]:checked + .slider::before {
  transform: translateX(24px);
}

.label-text {
  font-size: 14px;
  color: #1a202c;
  font-weight: 500;
}

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- ========== WELCOME PAGE ========== -->
  <div class="welcome-container" id="welcomePage">
    <div class="welcome-card">
      <div class="welcome-logo">📋</div>
      <h1>Requirements Monitoring System</h1>
      <p>Track and manage barangay requirements efficiently. Monitor weekly, monthly, quarterly, semestral, and annual compliance requirements in one centralized system.</p>
      <button class="get-started-btn" onclick="showMonitoring()">Get Started</button>
    </div>
  </div>

  <!-- ========== REQUIREMENTS LIST PAGE ========== -->
  <div class="monitoring-container" id="monitoringPage">
    <div class="monitoring-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <img src="{% static 'Pictures/logo1.png' %}" class="logo" alt="DILG Logo" />
        <h3>Barangay</h3>
        
        <ul class="barangay-list" id="barangayList">
          {% for barangay in barangays %}
          <li data-id="{{ barangay.id }}" onclick="selectBarangay(this, '{{ barangay.name }}', {{ barangay.id }})">
            {{ barangay.name }}
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Main Content -->
      <div class="content">
        <!-- Top Bar -->
        <div class="top-bar">
          <h1></h1>
          <div class="top-controls">
            <div class="notification-container">
  <button class="notification-bell" onclick="toggleNotifications()" title="Notifications">
    <i class="fa-solid fa-bell" style="color:#0b1a50; font-size:24px;"></i>
    <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
  </button>
  
  <div class="notification-dropdown" id="notificationDropdown">
    <div class="notification-header">
      <h3>Notifications</h3>
      <button class="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
    </div>
    
    <div class="notification-list" id="notificationList">
      <!-- Notifications will be loaded here -->
      <div class="notification-empty">
        <div class="notification-empty-icon">🔔</div>
        <p>No notifications yet</p>
      </div>
    </div>
    
    <div class="notification-footer">
      <button class="view-all-btn" onclick="viewAllNotifications()">View All Notifications</button>
    </div>
  </div>
</div>
            <button class="back-button" onclick="showWelcome()">← Back</button>
            <div class="user-icon" onclick="toggleUserDropdown()">{{ request.user.first_name.0|default:'U' }}
              <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item" onclick="viewProfile()">Profile</div>
                <div class="user-dropdown-item" onclick="viewSettings()">Settings</div>
                <div class="user-dropdown-item" onclick="logout()">Logout</div>
              </div>
            </div>
          </div>
        </div>

        <div class="top-bar">
          <h1>Requirements Monitoring{% if is_submitter %} - Submit Requirements{% endif %}</h1>
          <!-- rest of top-bar code -->
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
          <button class="tab active" onclick="filterByPeriod(this, 'weekly')">Weekly</button>
          <button class="tab" onclick="filterByPeriod(this, 'monthly')">Monthly</button>
          <button class="tab" onclick="filterByPeriod(this, 'semestral')">Semestral</button>
          <button class="tab" onclick="filterByPeriod(this, 'quarterly')">Quarterly</button>
          <button class="tab" onclick="filterByPeriod(this, 'annually')">Annually</button>
          <input type="text" class="search-box" placeholder="Search" id="searchBox" onkeyup="searchRequirements()">
        </div>

        <!-- Barangay Info -->
        <div class="barangay-header">
          <h2 id="selectedBarangay">Select a Barangay</h2>
          <span class="date" id="currentDate"></span>
          <span class="week-btn" onclick="toggleWeekDropdown()">Week <span id="currentWeekNum">01</span> ⬇
            <div class="week-dropdown" id="weekDropdown">
              <div class="week-dropdown-item" onclick="selectWeek(1)">Week 01</div>
              <div class="week-dropdown-item" onclick="selectWeek(2)">Week 02</div>
              <div class="week-dropdown-item" onclick="selectWeek(3)">Week 03</div>
              <div class="week-dropdown-item" onclick="selectWeek(4)">Week 04</div>
              <div class="week-dropdown-item" onclick="selectWeek(5)">Week 05</div>
            </div>
          </span>
        </div>

        <!-- Task Cards Container -->
        <div id="taskCardsContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Select a barangay to view requirements</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== DETAIL/INPUT PAGE ========== -->
  <div class="detail-container" id="detailPage">
    <div class="detail-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <img src="{% static 'Pictures/logo1.png' %}" class="logo" alt="DILG Logo" />
        <h3>Barangay</h3>
          <ul class="barangay-list" id="barangayList">
            <!-- Numeric Barangays (IDs 6-16 based on your database) -->
            <li data-id="6" onclick="selectBarangay(this, 'Barangay I', 6)">Barangay I</li>
            <li data-id="7" onclick="selectBarangay(this, 'Barangay II', 7)">Barangay II</li>
            <li data-id="8" onclick="selectBarangay(this, 'Barangay III', 8)">Barangay III</li>
            <li data-id="9" onclick="selectBarangay(this, 'Barangay IV', 9)">Barangay IV</li>
            <li data-id="10" onclick="selectBarangay(this, 'Barangay V', 10)">Barangay V</li>
            <li data-id="11" onclick="selectBarangay(this, 'Barangay VI', 11)">Barangay VI</li>
            <li data-id="12" onclick="selectBarangay(this, 'Barangay VII', 12)">Barangay VII</li>
            <li data-id="13" onclick="selectBarangay(this, 'Barangay VIII', 13)">Barangay VIII</li>
            <li data-id="14" onclick="selectBarangay(this, 'Barangay IX', 14)">Barangay IX</li>
            <li data-id="15" onclick="selectBarangay(this, 'Barangay X', 15)">Barangay X</li>
            <li data-id="16" onclick="selectBarangay(this, 'Barangay XI', 16)">Barangay XI</li>
            
            <!-- Named Barangays (IDs 17-38 based on your database) -->
            <li data-id="17" onclick="selectBarangay(this, 'Barra', 17)">Barra</li>
            <li data-id="18" onclick="selectBarangay(this, 'Bocohan', 18)">Bocohan</li>
            <li data-id="19" onclick="selectBarangay(this, 'Cotta', 19)">Cotta</li>
            <li data-id="20" onclick="selectBarangay(this, 'Dalahican', 20)">Dalahican</li>
            <li data-id="21" onclick="selectBarangay(this, 'Domoit', 21)">Domoit</li>
            <li data-id="22" onclick="selectBarangay(this, 'Gulang-Gulang', 22)">Gulang-Gulang</li>
            <li data-id="23" onclick="selectBarangay(this, 'Ibabang Dupay', 23)">Ibabang Dupay</li>
            <li data-id="24" onclick="selectBarangay(this, 'Ibabang Iyam', 24)">Ibabang Iyam</li>
            <li data-id="25" onclick="selectBarangay(this, 'Ibabang Talim', 25)">Ibabang Talim</li>
            <li data-id="26" onclick="selectBarangay(this, 'Ilayang Dupay', 26)">Ilayang Dupay</li>
            <li data-id="27" onclick="selectBarangay(this, 'Ilayang Iyam', 27)">Ilayang Iyam</li>
            <li data-id="28" onclick="selectBarangay(this, 'Ilayang Talim', 28)">Ilayang Talim</li>
            <li data-id="29" onclick="selectBarangay(this, 'Isabang', 29)">Isabang</li>
            <li data-id="30" onclick="selectBarangay(this, 'Market View', 30)">Market View</li>
            <li data-id="31" onclick="selectBarangay(this, 'Mayao Castillo', 31)">Mayao Castillo</li>
            <li data-id="32" onclick="selectBarangay(this, 'Mayao Crossing', 32)">Mayao Crossing</li>
            <li data-id="33" onclick="selectBarangay(this, 'Mayao Kanluran', 33)">Mayao Kanluran</li>
            <li data-id="34" onclick="selectBarangay(this, 'Mayao Parada', 34)">Mayao Parada</li>
            <li data-id="35" onclick="selectBarangay(this, 'Mayao Silangan', 35)">Mayao Silangan</li>
            <li data-id="36" onclick="selectBarangay(this, 'Ransohan', 36)">Ransohan</li>
            <li data-id="37" onclick="selectBarangay(this, 'Salinas', 37)">Salinas</li>
            <li data-id="38" onclick="selectBarangay(this, 'Talao-Talao', 38)">Talao-Talao</li>
  </ul>
      </div>

      <!-- Detail Content -->
      <div class="detail-content">
        <div class="top-bar">
          <h1>Requirements Monitoring</h1>
          <div class="top-controls">
            <button class="back-button" onclick="backToMonitoring()">← Back</button>
            <div class="user-icon" onclick="toggleUserDropdown()">{{ request.user.first_name.0|default:'U' }}
              <div class="user-dropdown" id="userDropdown2">
                <div class="user-dropdown-item" onclick="viewProfile()">Profile</div>
                <div class="user-dropdown-item" onclick="viewSettings()">Settings</div>
                <div class="user-dropdown-item" onclick="logout()">Logout</div>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-header">
            <div>
              <h2 id="requirementTitle">Loading...</h2>
              <span class="date" id="detailDate"></span>
            </div>
            <button class="update-btn" onclick="saveUpdate()">Save Update</button>
          </div>

          <div class="detail-description" id="requirementDescription">
            <p>Loading requirement details...</p>
          </div>

          <div class="input-section">
            <label>Input updates here</label>
            <textarea id="updateTextarea" placeholder="Enter your updates and progress details here..."></textarea>
          </div>

          <div class="input-section">
            <label>Upload Images</label>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
              <div class="upload-icon">☁️</div>
              <p>Click to upload images</p>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
            <div class="uploaded-files" id="uploadedFiles"></div>
          </div>

          <div class="detail-footer">
            <div class="info">
              <p><strong>Status:</strong> <span id="detailStatus">-</span></p>
              <p><strong>Due date:</strong> <span id="detailDueDate">-</span></p>
              <p><strong>Last Update:</strong> <span id="detailLastUpdate">-</span></p>
            </div>
            <button class="submit-btn" onclick="submitRequirement()">Submit to Admin</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentSubmissionId = null;
    let currentBarangayId = null;
    let currentPeriod = 'weekly';
    let currentWeek = 1;
    let uploadedFilesList = [];
    const csrfToken = '{{ csrf_token }}';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateCurrentDate();
    });

    // ========== NAVIGATION FUNCTIONS ==========
    function showMonitoring() {
      document.getElementById('welcomePage').style.display = 'none';
      document.getElementById('monitoringPage').style.display = 'block';
      document.getElementById('detailPage').style.display = 'none';
      
      const firstBarangay = document.querySelector('.barangay-list li');
      if (firstBarangay) {
        firstBarangay.click();
      }
    }

    function showWelcome() {
      document.getElementById('welcomePage').style.display = 'flex';
      document.getElementById('monitoringPage').style.display = 'none';
      document.getElementById('detailPage').style.display = 'none';
    }

    function backToMonitoring() {
      document.getElementById('welcomePage').style.display = 'none';
      document.getElementById('monitoringPage').style.display = 'block';
      document.getElementById('detailPage').style.display = 'none';
      
      if (currentBarangayId) {
        loadRequirements(currentBarangayId);
      }
    }

    // ========== BARANGAY FUNCTIONS ==========
    function selectBarangay(element, barangayName, barangayId) {
      const items = document.querySelectorAll('#barangayList li');
      items.forEach(item => item.classList.remove('active'));
      element.classList.add('active');
      
      currentBarangayId = barangayId;
      document.getElementById('selectedBarangay').textContent = barangayName;
      
      loadRequirements(barangayId);
    }

    // ========== LOAD REQUIREMENTS ==========
    function loadRequirements(barangayId) {
      const container = document.getElementById('taskCardsContainer');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading requirements...</p></div>';
      
      const params = new URLSearchParams({
        barangay_id: barangayId,
        period: currentPeriod,
        week: currentWeek,
        search: document.getElementById('searchBox').value
      });
      
      fetch(`/api/requirements/list/?${params}`, {
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderRequirements(data.submissions);
        } else {
          showToast(data.error || 'Failed to load requirements', 'error');
          container.innerHTML = '<div class="loading"><p>Error loading requirements</p></div>';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Network error', 'error');
        container.innerHTML = '<div class="loading"><p>Network error</p></div>';
      });
    }

    // ========== RENDER REQUIREMENTS ==========
    function renderRequirements(submissions) {
      const container = document.getElementById('taskCardsContainer');
      
      if (submissions.length === 0) {
        container.innerHTML = '<div class="loading"><p>No requirements found</p></div>';
        return;
      }
      
      container.innerHTML = '';
      
      submissions.forEach(sub => {
        const card = document.createElement('div');
        card.className = 'task-card';
        card.setAttribute('data-name', sub.title.toLowerCase());
        
        const statusClass = sub.status.replace('_', '-');
        
        card.innerHTML = `
          <h3>${sub.title}</h3>
          <p class="status ${statusClass}"><strong>Status:</strong> ${sub.status_display}</p>
          <p><strong>Due Date:</strong> ${sub.due_date}</p>
          <p class="last-update">Last Update: ${sub.last_update}</p>
          ${sub.is_overdue ? '<p style="color: #ef4444; font-weight: bold;">⚠️ Overdue</p>' : ''}
          <div class="card-actions">
            <button class="view-btn" onclick="viewSubmission(${sub.id})">View</button>
            <button class="delete-btn" onclick="deleteSubmission(${sub.id}, '${sub.title}')">Delete</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // ========== VIEW SUBMISSION DETAIL ==========
    function viewSubmission(submissionId) {
      currentSubmissionId = submissionId;
      
      fetch(`/api/requirements/submission/${submissionId}/`, {
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const sub = data.submission;
          
          document.getElementById('requirementTitle').textContent = sub.requirement.title;
          document.getElementById('requirementDescription').innerHTML = `<p>${sub.requirement.description}</p>`;
          document.getElementById('detailDate').textContent = new Date().toLocaleDateString();
          document.getElementById('updateTextarea').value = sub.update_text || '';
          document.getElementById('detailStatus').textContent = sub.status_display;
          document.getElementById('detailDueDate').textContent = sub.due_date;
          document.getElementById('detailLastUpdate').textContent = sub.last_update;
          
          renderAttachments(sub.attachments);
          
          document.getElementById('welcomePage').style.display = 'none';
          document.getElementById('monitoringPage').style.display = 'none';
          document.getElementById('detailPage').style.display = 'block';
        } else {
          showToast(data.error || 'Failed to load submission', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Network error', 'error');
      });
    }

    // ========== RENDER ATTACHMENTS ==========
    function renderAttachments(attachments) {
      const container = document.getElementById('uploadedFiles');
      container.innerHTML = '';
      
      attachments.forEach(att => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <span>📎 ${att.file_name} (${att.file_size} KB)</span>
          <button class="remove-file" onclick="removeAttachment(${att.id})">Remove</button>
        `;
        container.appendChild(fileItem);
      });
    }

    // ========== SAVE UPDATE ==========
    function saveUpdate() {
      const updateText = document.getElementById('updateTextarea').value.trim();
      
      if (!updateText) {
        showToast('Please enter update details', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('update_text', updateText);
      
      fetch(`/api/requirements/submission/${currentSubmissionId}/update/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Update saved successfully', 'success');
          document.getElementById('detailLastUpdate').textContent = data.submission.last_update;
        } else {
          showToast(data.error || 'Failed to save update', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Network error', 'error');
      });
    }

    // ========== FILE UPLOAD ==========
    function handleFileSelect(event) {
      const files = event.target.files;
      
      if (files.length === 0) return;
      
      // Validate file types and sizes
      for (let file of files) {
        if (!file.type.startsWith('image/')) {
          showToast('Only image files are allowed', 'error');
          return;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          showToast('File size must be less than 5MB', 'error');
          return;
        }
      }
      
      // Upload each file
      for (let file of files) {
        uploadFile(file);
      }
      
      // Reset input
      event.target.value = '';
    }

    function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('submission_id', currentSubmissionId);  // Make sure this is set
  
  // Debug: Check what we're sending
  console.log('Uploading file:', file.name);
  console.log('Submission ID:', currentSubmissionId);
  console.log('CSRF Token:', csrfToken);
  
  fetch('/api/requirements/attachment/upload/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      showToast('File uploaded successfully', 'success');
      addFileToList(data.attachment);
    } else {
      showToast(data.error || 'Failed to upload file', 'error');
    }
  })
  .catch(error => {
    console.error('Upload error:', error);
    showToast('Upload failed', 'error');
  });
}

    function addFileToList(attachment) {
      const container = document.getElementById('uploadedFiles');
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.setAttribute('data-id', attachment.id);
      fileItem.innerHTML = `
        <span>📎 ${attachment.file_name} (${attachment.file_size} KB)</span>
        <button class="remove-file" onclick="removeAttachment(${attachment.id})">Remove</button>
      `;
      container.appendChild(fileItem);
    }

    // ========== REMOVE ATTACHMENT ==========
    function removeAttachment(attachmentId) {
      if (!confirm('Are you sure you want to remove this file?')) {
        return;
      }
      
      fetch(`/api/requirements/attachment/${attachmentId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('File removed successfully', 'success');
          const fileItem = document.querySelector(`.file-item[data-id="${attachmentId}"]`);
          if (fileItem) {
            fileItem.remove();
          }
        } else {
          showToast(data.error || 'Failed to remove file', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Network error', 'error');
      });
    }

    // ========== SUBMIT TO ADMIN ==========
    async function submitRequirement() {
  const updateText = document.getElementById('updateTextarea').value.trim();
  
  if (!updateText) {
    showToast('Please enter update details before submitting', 'error');
    return;
  }
  
  if (!confirm('Are you sure you want to submit this requirement to admin? This will mark it as accomplished.')) {
    return;
  }
  
  try {
    // STEP 1: Save the update text first
    console.log('Step 1: Saving update text...');
    const saveResponse = await fetch(`/api/requirements/submission/${currentSubmissionId}/update/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `update_text=${encodeURIComponent(updateText)}`
    });
    
    const saveData = await saveResponse.json();
    
    if (!saveData.success) {
      showToast(saveData.error || 'Failed to save update', 'error');
      return;
    }
    
    console.log('Step 1: Update saved successfully');
    
    // STEP 2: Now submit to admin
    console.log('Step 2: Submitting to admin...');
    const submitResponse = await fetch(`/api/requirements/submission/${currentSubmissionId}/submit/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    
    const submitData = await submitResponse.json();
    
    if (submitData.success) {
      showToast('Successfully submitted to admin!', 'success');
      document.getElementById('detailStatus').textContent = submitData.submission.status_display;
      
      // Return to monitoring page after 1.5 seconds
      setTimeout(() => {
        backToMonitoring();
      }, 1500);
    } else {
      showToast(submitData.error || 'Failed to submit', 'error');
    }
    
  } catch (error) {
    console.error('Submit error:', error);
    showToast('Network error during submission', 'error');
  }
}

    // ========== DELETE SUBMISSION ==========
    function deleteSubmission(submissionId, title) {
      if (!confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
        return;
      }
      
      fetch(`/api/requirements/submission/${submissionId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Requirement deleted successfully', 'success');
          if (currentBarangayId) {
            loadRequirements(currentBarangayId);
          }
        } else {
          showToast(data.error || 'Failed to delete', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Network error', 'error');
      });
    }

    // ========== FILTER BY PERIOD ==========
    function filterByPeriod(element, period) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      element.classList.add('active');
      
      currentPeriod = period;
      
      if (currentBarangayId) {
        loadRequirements(currentBarangayId);
      }
    }

    // ========== SEARCH REQUIREMENTS ==========
    function searchRequirements() {
      if (currentBarangayId) {
        loadRequirements(currentBarangayId);
      }
    }

    // ========== WEEK FUNCTIONS ==========
    function toggleWeekDropdown() {
      const dropdown = document.getElementById('weekDropdown');
      dropdown.classList.toggle('show');
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function closeDropdown(e) {
        if (!e.target.closest('.week-btn')) {
          dropdown.classList.remove('show');
          document.removeEventListener('click', closeDropdown);
        }
      });
    }

    function selectWeek(weekNum) {
      currentWeek = weekNum;
      document.getElementById('currentWeekNum').textContent = String(weekNum).padStart(2, '0');
      document.getElementById('weekDropdown').classList.remove('show');
      
      if (currentBarangayId) {
        loadRequirements(currentBarangayId);
      }
    }

    // ========== USER DROPDOWN ==========
    function toggleUserDropdown() {
      const dropdown = document.getElementById('userDropdown');
      const dropdown2 = document.getElementById('userDropdown2');
      
      if (dropdown) dropdown.classList.toggle('show');
      if (dropdown2) dropdown2.classList.toggle('show');
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function closeUserDropdown(e) {
        if (!e.target.closest('.user-icon')) {
          if (dropdown) dropdown.classList.remove('show');
          if (dropdown2) dropdown2.classList.remove('show');
          document.removeEventListener('click', closeUserDropdown);
        }
      });
    }

    function viewProfile() {
      window.location.href = '/profile/';
    }

    function viewSettings() {
      window.location.href = '/settings/';
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/logout/';
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      if (dateElement) {
        const today = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = today.toLocaleDateString('en-US', options);
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.week-btn')) {
        document.getElementById('weekDropdown').classList.remove('show');
      }
      if (!e.target.closest('.user-icon')) {
        const dropdown1 = document.getElementById('userDropdown');
        const dropdown2 = document.getElementById('userDropdown2');
        if (dropdown1) dropdown1.classList.remove('show');
        if (dropdown2) dropdown2.classList.remove('show');
      }
    });


    // Update barangay colors dynamically
    function updateBarangayColors() {
      const barangayItems = document.querySelectorAll('.barangay-list li');
      
      barangayItems.forEach(item => {
        const barangayId = item.getAttribute('data-id');
        
        // Fetch real-time status
        fetch(`/api/barangay/${barangayId}/status/`, {
          method: 'GET',
          credentials: 'same-origin',  
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'  
          }
        })
        .then(response => {
          if (!response.ok) {
            console.error(`Failed to fetch status for barangay ${barangayId}:`, response.status);
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data) {
            // Remove old status classes
            item.classList.remove('status-red', 'status-yellow', 'status-green', 'status-blue', 'status-gray');
            
            // Add new status class
            item.classList.add(`status-${data.color}`);
            
            // Update tooltip
            item.setAttribute('title', data.tooltip);
          }
        })
        .catch(error => {
          console.error(`Error fetching barangay ${barangayId} status:`, error);
        });
      });
    }

    
    // Update colors after actions (submit, delete, etc.)
    function refreshBarangayStatus(barangayId) {
      const item = document.querySelector(`.barangay-list li[data-id="${barangayId}"]`);
      if (!item) return;
      
      fetch(`/api/barangay/${barangayId}/status/`, {
        method: 'GET',
        credentials: 'same-origin',  
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'  
        }
      })
      .then(response => {
        if (!response.ok) {
          console.error(`Failed to fetch barangay ${barangayId} status:`, response.status);
          return null;
        }
        return response.json();
      })
      .then(data => {
        if (data) {
          // Remove old status classes
          item.classList.remove('status-red', 'status-yellow', 'status-green', 'status-blue', 'status-gray');
          
          // Add new status class
          item.classList.add(`status-${data.color}`);
          
          // Update tooltip
          item.setAttribute('title', data.tooltip);
        }
      })
      .catch(error => {
        console.error(`Error fetching barangay ${barangayId} status:`, error);
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateCurrentDate();
      
      // Initial color update
      updateBarangayColors();
      
      // Refresh colors every 30 seconds
      setInterval(updateBarangayColors, 30000);
    });
let notificationCheckInterval = null;

// Initialize notifications on page load
document.addEventListener('DOMContentLoaded', function() {
  loadNotifications();
  
  // Check for new notifications every 30 seconds
  notificationCheckInterval = setInterval(loadNotifications, 30000);
});

// Toggle notification dropdown
function toggleNotifications() {
  const dropdown = document.getElementById('notificationDropdown');
  const isShowing = dropdown.classList.contains('show');
  
  if (isShowing) {
    dropdown.classList.remove('show');
  } else {
    dropdown.classList.add('show');
    loadNotifications(); // Refresh when opening
  }
  
  // Close when clicking outside
  if (!isShowing) {
    setTimeout(() => {
      document.addEventListener('click', function closeNotification(e) {
        if (!e.target.closest('.notification-container')) {
          dropdown.classList.remove('show');
          document.removeEventListener('click', closeNotification);
        }
      });
    }, 100);
  }
}

// Load notifications from server
function loadNotifications() {
  fetch('/api/notifications/', {
    method: 'GET',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      renderNotifications(data.notifications);
      updateNotificationBadge(data.unread_count);
    }
  })
  .catch(error => {
    console.error('Error loading notifications:', error);
  });
}

// Render notifications
function renderNotifications(notifications) {
  const container = document.getElementById('notificationList');
  
  if (notifications.length === 0) {
    container.innerHTML = `
      <div class="notification-empty">
        <div class="notification-empty-icon">🔔</div>
        <p>No notifications yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  
  notifications.forEach(notif => {
    const item = document.createElement('div');
    item.className = `notification-item ${notif.is_read ? '' : 'unread'}`;
    item.setAttribute('data-id', notif.id);
    item.onclick = () => handleNotificationClick(notif);
    
    const iconClass = getNotificationIconClass(notif.type);
    const icon = getNotificationIcon(notif.type);
    
    item.innerHTML = `
      <div style="display: flex; align-items: start;">
        <div class="notification-icon ${iconClass}">
          ${icon}
        </div>
        <div class="notification-content">
          <div class="notification-title">${notif.title}</div>
          <div class="notification-message">${notif.message}</div>
          <div class="notification-time">${notif.time_ago}</div>
        </div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

// Get notification icon based on type
function getNotificationIconClass(type) {
  const iconMap = {
    'overdue': 'overdue',
    'upcoming': 'upcoming',
    'completed': 'completed',
    'reminder': 'upcoming',
    'info': 'info'
  };
  return iconMap[type] || 'info';
}

function getNotificationIcon(type) {
  const iconMap = {
    'overdue': '⚠️',
    'upcoming': '⏰',
    'completed': '✅',
    'reminder': '🔔',
    'info': 'ℹ️'
  };
  return iconMap[type] || '📌';
}

// Update notification badge
function updateNotificationBadge(count) {
  const badge = document.getElementById('notificationBadge');
  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// Handle notification click - updated to support announcements
function handleNotificationClick(notif) {
  // Mark as read
  markNotificationAsRead(notif.id);
  
  // Navigate based on notification type
  if (notif.type === 'info' && notif.announcement_id) {
    // For announcement notifications, just show a toast or modal
    showToast('Check announcements section for full details', 'success');
  } else if (notif.submission_id) {
    viewSubmission(notif.submission_id);
  } else if (notif.barangay_id) {
    const barangayElement = document.querySelector(`[data-id="${notif.barangay_id}"]`);
    if (barangayElement) {
      barangayElement.click();
    }
  }
  
  // Close dropdown
  document.getElementById('notificationDropdown').classList.remove('show');
}

// Mark notification as read
function markNotificationAsRead(notificationId) {
  fetch(`/api/notifications/${notificationId}/read/`, {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const item = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
      if (item) {
        item.classList.remove('unread');
      }
      
      // Update badge
      const currentBadge = document.getElementById('notificationBadge');
      const currentCount = parseInt(currentBadge.textContent) || 0;
      if (currentCount > 0) {
        updateNotificationBadge(currentCount - 1);
      }
    }
  })
  .catch(error => {
    console.error('Error marking notification as read:', error);
  });
}

// Mark all notifications as read
function markAllAsRead() {
  fetch('/api/notifications/mark-all-read/', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('All notifications marked as read', 'success');
      loadNotifications();
    }
  })
  .catch(error => {
    console.error('Error marking all as read:', error);
  });
}

// View all notifications (navigate to dedicated page)
function viewAllNotifications() {
  window.location.href = '/notifications/';
}

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
  if (notificationCheckInterval) {
    clearInterval(notificationCheckInterval);
  }
});
     function viewProfile() {
      showProfileModal();
    }

    function viewSettings() {
      showSettingsModal();
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/logout/';
      }
    }

    // Profile Modal Functions
    function showProfileModal() {
      const modal = document.getElementById('profileModal');
      if (!modal) {
        createProfileModal();
      }
      document.getElementById('profileModal').style.display = 'flex';
      loadUserProfile();
    }

    function createProfileModal() {
      const modal = document.createElement('div');
      modal.id = 'profileModal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content profile-modal">
          <span class="close-modal" onclick="closeProfileModal()">&times;</span>
          <h2>User Profile</h2>
          <div class="profile-content">
            <div class="profile-avatar">
              <div class="avatar-circle" id="profileAvatar">{{ request.user.first_name.0|default:'U' }}</div>
              <button class="change-avatar-btn" onclick="changeAvatar()">Change Avatar</button>
            </div>
            <div class="profile-info">
              <div class="info-group">
                <label>Full Name:</label>
                <input type="text" id="profileFullName" readonly>
              </div>
              <div class="info-group">
                <label>Email:</label>
                <input type="email" id="profileEmail" readonly>
              </div>
              <div class="info-group">
                <label>Username:</label>
                <input type="text" id="profileUsername" readonly>
              </div>
              <div class="info-group">
                <label>Role:</label>
                <input type="text" id="profileRole" readonly>
              </div>
              <div class="info-group">
                <label>Barangay:</label>
                <input type="text" id="profileBarangay" readonly>
              </div>
              <div class="info-group">
                <label>Member Since:</label>
                <input type="text" id="profileMemberSince" readonly>
              </div>
            </div>
          </div>
          <div class="profile-actions">
            <button class="btn-primary" onclick="editProfile()">Edit Profile</button>
            <button class="btn-secondary" onclick="changePassword()">Change Password</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
    }

    function loadUserProfile() {
      fetch('/api/user/profile/', {
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          // If endpoint doesn't exist, use fallback data from template
          return { success: false, use_fallback: true };
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          document.getElementById('profileFullName').value = data.user.full_name || '';
          document.getElementById('profileEmail').value = data.user.email || '';
          document.getElementById('profileUsername').value = data.user.username || '';
          document.getElementById('profileRole').value = data.user.role || '';
          document.getElementById('profileBarangay').value = data.user.barangay || '';
          document.getElementById('profileMemberSince').value = data.user.member_since || '';
        } else if (data.use_fallback) {
          // Use Django template data as fallback
          useFallbackProfileData();
        }
      })
      .catch(error => {
        console.error('Error loading profile:', error);
        useFallbackProfileData();
      });
    }

    function useFallbackProfileData() {
      // Extract data from Django template variables
      const userName = '{{ request.user.get_full_name|default:request.user.username }}';
      const userEmail = '{{ request.user.email }}';
      const username = '{{ request.user.username }}';
      
      // Try to get role from user groups or set default
      const userRole = '{% if request.user.groups.all %}{{ request.user.groups.all.0.name }}{% else %}Submitter{% endif %}';
      
      // Try to get barangay if profile exists
      const userBarangay = '{% if request.user.profile %}{{ request.user.profile.barangay.name }}{% else %}Not assigned{% endif %}';
      
      // Get date joined
      const memberSince = '{{ request.user.date_joined|date:"F d, Y" }}';
      
      document.getElementById('profileFullName').value = userName || 'User';
      document.getElementById('profileEmail').value = userEmail || 'No email';
      document.getElementById('profileUsername').value = username || 'username';
      document.getElementById('profileRole').value = userRole || 'User';
      document.getElementById('profileBarangay').value = userBarangay || 'Not assigned';
      document.getElementById('profileMemberSince').value = memberSince || 'Recently';
    }

    function editProfile() {
      const inputs = document.querySelectorAll('.profile-info input');
      const isReadOnly = inputs[0].hasAttribute('readonly');
      
      if (isReadOnly) {
        inputs.forEach(input => {
          if (input.id !== 'profileUsername' && input.id !== 'profileRole' && input.id !== 'profileMemberSince') {
            input.removeAttribute('readonly');
            input.style.background = 'white';
          }
        });
        document.querySelector('.profile-actions .btn-primary').textContent = 'Save Changes';
      } else {
        saveProfileChanges();
      }
    }

    function saveProfileChanges() {
      const formData = new FormData();
      formData.append('full_name', document.getElementById('profileFullName').value);
      formData.append('email', document.getElementById('profileEmail').value);
      formData.append('barangay', document.getElementById('profileBarangay').value);
      
      fetch('/api/user/profile/update/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          showToast('Profile update endpoint not available. Please contact administrator.', 'error');
          return { success: false };
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('Profile updated successfully', 'success');
          const inputs = document.querySelectorAll('.profile-info input');
          inputs.forEach(input => {
            input.setAttribute('readonly', true);
            input.style.background = '#f9fafb';
          });
          document.querySelector('.profile-actions .btn-primary').textContent = 'Edit Profile';
        } else if (data.success !== undefined) {
          showToast(data.error || 'Failed to update profile', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Profile update feature not available yet', 'error');
      });
    }

    function changePassword() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content password-modal">
          <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
          <h2>Change Password</h2>
          <div class="password-form">
            <div class="info-group">
              <label>Current Password:</label>
              <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="info-group">
              <label>New Password:</label>
              <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="info-group">
              <label>Confirm Password:</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-primary" onclick="submitPasswordChange()">Change Password</button>
            <button class="btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function submitPasswordChange() {
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      if (!current || !newPass || !confirm) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      if (newPass !== confirm) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      if (newPass.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('current_password', current);
      formData.append('new_password', newPass);
      
      fetch('/api/user/password/change/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          showToast('Password change endpoint not available. Please contact administrator.', 'error');
          return { success: false };
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('Password changed successfully', 'success');
          document.querySelector('.password-modal').parentElement.remove();
        } else if (data.success !== undefined) {
          showToast(data.error || 'Failed to change password', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Password change feature not available yet', 'error');
      });
    }

    function changeAvatar() {
      showToast('Avatar change feature coming soon', 'success');
    }

    // Settings Modal
    function showSettingsModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content settings-modal">
          <span class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</span>
          <h2>Settings</h2>
          <div class="settings-content">
            <div class="setting-group">
              <h3>Notifications</h3>
              <label class="toggle-switch">
                <input type="checkbox" id="emailNotifications" checked>
                <span class="slider"></span>
                <span class="label-text">Email Notifications</span>
              </label>
              <label class="toggle-switch">
                <input type="checkbox" id="pushNotifications" checked>
                <span class="slider"></span>
                <span class="label-text">Push Notifications</span>
              </label>
            </div>
            <div class="setting-group">
              <h3>Display</h3>
              <label class="toggle-switch">
                <input type="checkbox" id="darkMode">
                <span class="slider"></span>
                <span class="label-text">Dark Mode</span>
              </label>
            </div>
            <div class="setting-group">
              <h3>Privacy</h3>
              <label class="toggle-switch">
                <input type="checkbox" id="showProfile" checked>
                <span class="slider"></span>
                <span class="label-text">Show Profile to Others</span>
              </label>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
            <button class="btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveSettings() {
      const settings = {
        email_notifications: document.getElementById('emailNotifications').checked,
        push_notifications: document.getElementById('pushNotifications').checked,
        dark_mode: document.getElementById('darkMode').checked,
        show_profile: document.getElementById('showProfile').checked
      };
      
      fetch('/api/user/settings/update/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(settings)
      })
      .then(response => {
        if (!response.ok) {
          showToast('Settings endpoint not available. Please contact administrator.', 'error');
          return { success: false };
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showToast('Settings saved successfully', 'success');
          document.querySelector('.settings-modal').parentElement.remove();
        } else if (data.success !== undefined) {
          showToast(data.error || 'Failed to save settings', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Settings feature not available yet', 'error');
      });
    }
  </script>
</body>
</html>
      